services:
  nats:
    image: nats:latest
    network_mode: host
    command: ["-js", "-m", "8222"]

  jaeger:
    image: jaegertracing/all-in-one:latest
    network_mode: host

  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    network_mode: host
    command: ["--config=/etc/otelcol-contrib/config.yaml"]
    volumes:
      - ./otel-collector/config.yaml:/etc/otelcol-contrib/config.yaml:ro

  js-init:
    build:
      context: ./js-init
    network_mode: host
    depends_on:
      - nats
    environment:
      - NATS_URL=nats://127.0.0.1:4222

  flow-pipe:
    build:
      context: ./flow-pipe
    network_mode: host
    depends_on:
      - nats
      - otel-collector
      - js-init
    environment:
      - NATS_URL=nats://127.0.0.1:4222
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://127.0.0.1:4317
      - OTEL_EXPORTER_OTLP_PROTOCOL=grpc

  grpc-gateway:
    build:
      context: .
      dockerfile: grpc/Dockerfile
      target: gateway-runtime
    network_mode: host
    depends_on:
      - nats
      - otel-collector
      - js-init
    environment:
      - NATS_URL=nats://127.0.0.1:4222
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://127.0.0.1:4317
      - OTEL_EXPORTER_OTLP_PROTOCOL=grpc

  grpc-client:
    build:
      context: .
      dockerfile: grpc/Dockerfile
      target: client-runtime
    network_mode: host
    depends_on:
      - grpc-gateway
      - otel-collector
    environment:
      - GRPC_SERVER=127.0.0.1:50051
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://127.0.0.1:4317
      - OTEL_EXPORTER_OTLP_PROTOCOL=grpc
